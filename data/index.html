<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="/favicon.png">
    <title>TMC5160 Stepper Stand</title>
    <style>

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 0;
        }
        .container {
            max-width: 100%;
            margin: 0;
            background: white;
            min-height: 100vh;
        }
        
        .content { padding: 15px; }
        
        /* –ê–î–ê–ü–¢–ò–í–ù–´–ô –î–ò–ó–ê–ô–ù üì±üíª */
        /* –ü–ª–∞–Ω—à–µ—Ç—ã (–æ—Ç 768px) */
        @media (min-width: 768px) {
            body {
            padding: 20px;
        }
        .container {
                max-width: 750px;
            margin: 0 auto;
            border-radius: 16px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            }
            .content {
                padding: 25px;
            }
        }
        
        /* –î–µ—Å–∫—Ç–æ–ø—ã (–æ—Ç 1024px) */
        @media (min-width: 1024px) {
            body {
            padding: 30px;
            }
            .container {
                max-width: 900px;
                box-shadow: 0 8px 30px rgba(0,0,0,0.15);
            }
            .content {
                padding: 35px;
            }
        }
        
        /* ========== –í–ö–õ–ê–î–ö–ò ========== */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        .tab {
            padding: 12px 20px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            font-size: 1.1em;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            transition: all 0.3s;
        }
        .tab:hover {
            color: #667eea;
        }
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        /* –£–±–∏—Ä–∞–µ–º status-card –ø–æ–¥–ª–æ–∂–∫—É, –¥–µ–ª–∞–µ–º –ø–ª–æ—Å–∫–∏–º */
        .status-card {
            background: transparent;
            padding: 0;
            margin-bottom: 15px;
        }
        .status-card h2 { 
            font-size: 1.1em; 
            margin-bottom: 12px; 
            color: #333; 
            padding: 10px 0;
            border-bottom: 2px solid #667eea;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* 3 —Å—Ç–æ–ª–±—Ü–∞ √ó 2 —Å—Ç—Ä–æ–∫–∏! */
            gap: 10px;
        }
        .status-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }
        .status-item label { 
            font-size: 0.85em; 
            color: #666; 
            display: block; 
            margin-bottom: 5px; 
        }
        .status-item .value { 
            font-size: 1.2em; 
            font-weight: bold; 
            color: #333; 
        }
        .status-item .value.good { color: #28a745; }
        .status-item .value.bad { color: #dc3545; }
        
        .control-section {
            background: transparent;
            padding: 0;
            margin-bottom: 15px;
            border: none;
        }
        .control-section h3 {
            font-size: 1.05em;
            margin-bottom: 12px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr); /* 4 —Å—Ç–æ–ª–±—Ü–∞ √ó 2 —Å—Ç—Ä–æ–∫–∏! */
            gap: 10px;
        }
        .form-group {
            margin-bottom: 10px;
        }
        .form-group label {
            display: block;
            font-size: 0.9em;
            font-weight: 600;
            color: #555;
            margin-bottom: 5px;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }
        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        button {
            flex: 1;
            min-width: 55px;
            padding: 14px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(220, 53, 69, 0.4);
        }
        .btn-emergency {
            background: #ff0000;
            color: white;
            font-weight: bold;
            font-size: 1.1em;
            animation: pulse 2s infinite;
        }
        .btn-emergency:hover {
            background: #cc0000;
            transform: translateY(-2px);
        }
        
        /* –ö–†–£–ì–û–í–û–ï –ú–ï–ù–Æ –° –°–ï–ì–ú–ï–ù–¢–ê–ú–ò (–ü–ò–¶–¶–ê) üçï */
        .angle-circle-container {
            position: relative;
            width: 410px;
            height: 410px;
            max-width: 90vw; /* –ù–ï –ë–û–õ–¨–®–ï 90% —à–∏—Ä–∏–Ω—ã —ç–∫—Ä–∞–Ω–∞! */
            max-height: 90vw; /* –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–≤–∞–¥—Ä–∞—Ç! */
            margin: 30px auto;
            background: white;
            border-radius: 50%;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .angle-circle {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            height: 300px;
            padding: 0;
            margin: 0;
            list-style: none;
            border-radius: 50%;
            overflow: hidden;
        }
        .angle-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100px;
            height: 100px;
            background: #667eea;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.5);
            z-index: 1000;
            border: 5px solid #fff;
        }
        .angle-center-label {
            font-size: 0.7em;
            opacity: 0.9;
        }
        .angle-center-value {
            font-size: 1.4em;
        }
        /* –°–µ–≥–º–µ–Ω—Ç—ã –ø–∏—Ü—Ü—ã */
        .angle-segment {
            position: absolute;
            top: -10px;
            left: -10px;
            width: 160px;
            height: 160px;
            transform-origin: 100% 100%;
            overflow: hidden;
        }
        .angle-segment button {
            display: block;
            width: 100%;
            height: 100%;
            border: none;
            background: rgba(102, 126, 234, 0.3);
            color: transparent;
            font-size: 0;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .angle-segment:nth-child(even) button {
            background: rgba(102, 126, 234, 0.15);
        }
        .angle-segment button:hover {
            background: rgba(102, 126, 234, 0.8);
            color: white;
        }
        /* –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ —É–≥–ª—ã - –Ω–µ–º–Ω–æ–≥–æ –¥—Ä—É–≥–æ–π –æ—Ç—Ç–µ–Ω–æ–∫ */
        .angle-segment.negative button {
            background: rgba(118, 75, 162, 0.3);
            color: #764ba2;
        }
        .angle-segment.negative:nth-child(even) button {
            background: rgba(118, 75, 162, 0.15);
        }
        .angle-segment.negative button:hover {
            background: rgba(118, 75, 162, 0.8);
            color: white;
        }
        /* –ü–æ–∑–∏—Ü–∏–∏ —Å–µ–≥–º–µ–Ω—Ç–æ–≤ (16 —à—Ç—É–∫ –ø–æ 22.5¬∞) - –†–ê–ó–í–û–†–û–¢ +180¬∞ - 90¬∞ - 11.25¬∞ = +78.75¬∞ —á—Ç–æ–±—ã 0¬∞ —Å–º–æ—Ç—Ä–µ–ª –Ω–∞ 0¬∞! */
        .angle-segment:nth-child(1) { transform: rotate(78.75deg) skew(67.5deg); }
        .angle-segment:nth-child(2) { transform: rotate(101.25deg) skew(67.5deg); }
        .angle-segment:nth-child(3) { transform: rotate(123.75deg) skew(67.5deg); }
        .angle-segment:nth-child(4) { transform: rotate(146.25deg) skew(67.5deg); }
        .angle-segment:nth-child(5) { transform: rotate(168.75deg) skew(67.5deg); }
        .angle-segment:nth-child(6) { transform: rotate(191.25deg) skew(67.5deg); }
        .angle-segment:nth-child(7) { transform: rotate(213.75deg) skew(67.5deg); }
        .angle-segment:nth-child(8) { transform: rotate(236.25deg) skew(67.5deg); }
        .angle-segment:nth-child(9) { transform: rotate(258.75deg) skew(67.5deg); }
        .angle-segment:nth-child(10) { transform: rotate(281.25deg) skew(67.5deg); }
        .angle-segment:nth-child(11) { transform: rotate(303.75deg) skew(67.5deg); }
        .angle-segment:nth-child(12) { transform: rotate(326.25deg) skew(67.5deg); }
        .angle-segment:nth-child(13) { transform: rotate(348.75deg) skew(67.5deg); }
        .angle-segment:nth-child(14) { transform: rotate(371.25deg) skew(67.5deg); }
        .angle-segment:nth-child(15) { transform: rotate(393.75deg) skew(67.5deg); }
        .angle-segment:nth-child(16) { transform: rotate(416.25deg) skew(67.5deg); }
        
        /* –Ø–†–õ–´–ö–ò –°–ù–ê–†–£–ñ–ò –ö–†–£–ì–ê */
        .angle-label {
            position: absolute;
            font-size: 0.85em;
            font-weight: 700;
            color: #667eea;
            pointer-events: none; /* –ù–µ –º–µ—à–∞–µ–º –∫–ª–∏–∫–∞–º */
            white-space: nowrap; /* –ù–µ –ø–µ—Ä–µ–Ω–æ—Å–∏–º —Ç–µ–∫—Å—Ç */
        }
        .angle-label.negative { color: #764ba2; }
        
        /* –ú–æ–±–∏–ª—å–Ω—ã–µ: —É–º–µ–Ω—å—à–∞–µ–º —à—Ä–∏—Ñ—Ç —è—Ä–ª—ã–∫–æ–≤ */
        @media (max-width: 480px) {
            .angle-label {
                font-size: 0.65em;
            }
        }
        
        /* –ü–æ–∑–∏—Ü–∏–∏ —è—Ä–ª—ã–∫–æ–≤ (radius = 180px –æ—Ç —Ü–µ–Ω—Ç—Ä–∞) */
        .label-0 { left: 50%; top: calc(50% - 180px); transform: translate(-50%, -50%); }
        .label-22-5 { left: calc(50% + 70px); top: calc(50% - 165px); transform: translate(-50%, -50%); }
        .label-45 { left: calc(50% + 127px); top: calc(50% - 127px); transform: translate(-50%, -50%); }
        .label-67-5 { left: calc(50% + 165px); top: calc(50% - 70px); transform: translate(-50%, -50%); }
        .label-90 { left: calc(50% + 180px); top: 50%; transform: translate(-50%, -50%); }
        .label-112-5 { left: calc(50% + 165px); top: calc(50% + 70px); transform: translate(-50%, -50%); }
        .label-135 { left: calc(50% + 127px); top: calc(50% + 127px); transform: translate(-50%, -50%); }
        .label-157-5 { left: calc(50% + 70px); top: calc(50% + 165px); transform: translate(-50%, -50%); }
        .label-180 { left: 50%; top: calc(50% + 180px); transform: translate(-50%, -50%); }
        .label-minus-157-5 { left: calc(50% - 70px); top: calc(50% + 165px); transform: translate(-50%, -50%); }
        .label-minus-135 { left: calc(50% - 127px); top: calc(50% + 127px); transform: translate(-50%, -50%); }
        .label-minus-112-5 { left: calc(50% - 165px); top: calc(50% + 70px); transform: translate(-50%, -50%); }
        .label-minus-90 { left: calc(50% - 180px); top: 50%; transform: translate(-50%, -50%); }
        .label-minus-67-5 { left: calc(50% - 165px); top: calc(50% - 70px); transform: translate(-50%, -50%); }
        .label-minus-45 { left: calc(50% - 127px); top: calc(50% - 127px); transform: translate(-50%, -50%); }
        .label-minus-22-5 { left: calc(50% - 70px); top: calc(50% - 165px); transform: translate(-50%, -50%); }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 0, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); }
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(40, 167, 69, 0.4);
        }
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        .btn-info:hover {
            background: #138496;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(23, 162, 184, 0.4);
        }
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        .btn-warning:hover {
            background: #e0a800;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(255, 193, 7, 0.4);
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(108, 117, 125, 0.4);
        }
        .btn-preset {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            line-height: 1.2;
        }
        .btn-preset:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }
        .btn-preset small {
            font-size: 0.8em;
            opacity: 0.9;
            margin-top: 2px;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .message {
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }
        .log-line {
            margin: 2px 0;
            padding: 2px 0;
        }
        .log-success {
            color: #4ec9b0;
        }
        .log-error {
            color: #f48771;
        }
        .log-warning {
            color: #dcdcaa;
        }
        .log-info {
            color: #569cd6;
        }
        .message.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .message.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .message.show { display: block; }
        
        .diagnostic-output {
            background: #1e1e1e;
            color: #00ff00;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 15px;
            display: none;
        }
        .diagnostic-output.show { display: block; }
        
        /* –ú–æ–±–∏–ª—å–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ */
        @media (max-width: 1024px) {
            .container { max-width: 720px; }
            .form-grid { grid-template-columns: 1fr; }
        }
        
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            .button-group {
                flex-direction: column;
            }
        button {
                width: 100%;
            }
            body { padding: 10px; }
            .content { padding: 16px; }
            .control-section { padding: 16px; }
        }
    </style>
</head>
<body>
    <div class="container">

        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫ —É–¥–∞–ª–µ–Ω—ã –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é -->
        
        <div class="content">
            <!-- –í–∫–ª–∞–¥–∫–∏ -->
            <div class="tabs">
                <button class="tab active" data-tab="stepper" onclick="switchTab('stepper', this)">üîß –®–∞–≥–æ–≤—ã–π –¥–≤–∏–≥–∞—Ç–µ–ª—å</button>
                <button class="tab" data-tab="solenoid" onclick="switchTab('solenoid', this)">üîå –°–æ–ª–µ–Ω–æ–∏–¥</button>
            </div>

            <!-- –í–∫–ª–∞–¥–∫–∞ 1: –®–∞–≥–æ–≤—ã–π –¥–≤–∏–≥–∞—Ç–µ–ª—å -->
            <div id="tab-stepper" class="tab-content active">
            
            <!-- –°—Ç–∞—Ç—É—Å -->
            <div class="status-card">
                <h2>üìä –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å</h2>
                <div class="status-grid">
                    <div class="status-item">
                        <label>–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è</label>
                        <div class="value" id="status-init">‚ùå –ù–ï–¢</div>
                    </div>
                    <div class="status-item">
                        <label>–î—Ä–∞–π–≤–µ—Ä</label>
                        <div class="value" id="status-enabled">‚ùå –í–´–ö–õ</div>
                    </div>
                    <div class="status-item">
                        <label>–î–≤–∏–∂–µ–Ω–∏–µ</label>
                        <div class="value" id="status-moving">‚è∏Ô∏è –ù–ï–¢</div>
                    </div>
                    <div class="status-item">
                        <label>–ü–æ–∑–∏—Ü–∏—è (—à–∞–≥–∏)</label>
                        <div class="value" id="status-position">0</div>
                    </div>
                    <div class="status-item">
                        <label>–°–∫–æ—Ä–æ—Å—Ç—å (—à–∞–≥–∏/—Å)</label>
                        <div class="value" id="status-speed">0.0</div>
                    </div>
                    <div class="status-item">
                        <label>–û—Å—Ç–∞–ª–æ—Å—å</label>
                        <div class="value" id="status-remaining">0</div>
                    </div>
                </div>
            </div>
            
            <!-- –ï–¥–∏–Ω–æ–µ –º–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫ + –ø—Ä–µ—Å–µ—Ç—ã -->
            <div class="control-section">
                <h3>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–≤–∏–∂–µ–Ω–∏—è –∏ –¥—Ä–∞–π–≤–µ—Ä–∞</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="preset_select">–ü—Ä–µ—Å–µ—Ç</label>
                        <select id="preset_select"></select>
                    </div>
                    <!-- –†–µ–∂–∏–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω: Motion Controller (SPI) -->
                    <div class="form-group">
                        <label for="max_speed">–ú–∞–∫—Å. —Å–∫–æ—Ä–æ—Å—Ç—å (—à–∞–≥–∏/—Å)</label>
                        <input type="number" id="max_speed" value="1000" min="1" max="50000">
                    </div>
                    <div class="form-group">
                        <label for="acceleration">–£—Å–∫–æ—Ä–µ–Ω–∏–µ (—à–∞–≥–∏/—Å¬≤)</label>
                        <input type="number" id="acceleration" value="500" min="1" max="10000">
        </div>
                    <div class="form-group">
                        <label for="deceleration">–¢–æ—Ä–º–æ–∂–µ–Ω–∏–µ (—à–∞–≥–∏/—Å¬≤)</label>
                        <input type="number" id="deceleration" value="500" min="1" max="10000">
        </div>
                    <div class="form-group">
                        <label for="steps_per_rev">–®–∞–≥–æ–≤ –Ω–∞ –æ–±–æ—Ä–æ—Ç</label>
                        <input type="number" id="steps_per_rev" value="200" min="1">
                    </div>
                    <div class="form-group">
                        <label for="driver_current">–¢–æ–∫ (mA)</label>
            <input type="number" id="driver_current" value="800" min="100" max="3000">
                    </div>
                    <div class="form-group">
                        <label for="driver_hold_mult">Hold Multiplier</label>
                        <input type="number" id="driver_hold_mult" value="0.5" step="0.1" min="0" max="1">
                    </div>
                    <div class="form-group">
                        <label for="driver_microsteps">–ú–∏–∫—Ä–æ—à–∞–≥–∏</label>
            <select id="driver_microsteps">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="4">4</option>
                <option value="8">8</option>
                <option value="16" selected>16</option>
                <option value="32">32</option>
                <option value="64">64</option>
                <option value="128">128</option>
                <option value="256">256</option>
            </select>
                    </div>
                </div>
            <div class="button-group">
                <button class="btn-success" onclick="saveSettings()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                </div>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∏ –≤–∫–ª—é—á–µ–Ω–∏—è/–≤—ã–∫–ª—é—á–µ–Ω–∏—è –º–æ—Ç–æ—Ä–∞ -->
            <div class="button-group">
                <button class="btn-success" onclick="enableMotor()">üîã –í–∫–ª—é—á–∏—Ç—å –º–æ—Ç–æ—Ä (HOLD)</button>
                <button class="btn-secondary" onclick="disableMotor()">‚ö° –í—ã–∫–ª—é—á–∏—Ç—å –º–æ—Ç–æ—Ä</button>
            </div>

            <!-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —à–∞–≥–æ–≤ –∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ü–ï–†–ï–î –∫–Ω–æ–ø–∫–∞–º–∏ —Å—Ç–∞—Ä—Ç/—Å—Ç–æ–ø -->
            <div class="control-section">
                <h3>üéØ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏–µ–º</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="steps">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —à–∞–≥–æ–≤</label>
                        <input type="number" id="steps" value="200" min="1">
            </div>
                    <div class="form-group">
                        <label for="direction">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</label>
                        <select id="direction">
                            <option value="forward">‚ñ∂Ô∏è –í–ø–µ—Ä—ë–¥</option>
                            <option value="backward">‚óÄÔ∏è –ù–∞–∑–∞–¥</option>
                        </select>
            </div>
                    <div class="form-group">
                        <label for="gear_ratio" title="–†–µ–¥—É–∫—Ç–æ—Ä/—Ä–µ–º–µ–Ω—å: 3.0 = 1:3, 0.333 = 3:1">‚öôÔ∏è –ü–µ—Ä–µ–¥–∞—Ç–æ—á–Ω–æ–µ —á–∏—Å–ª–æ</label>
                        <input type="number" id="gear_ratio" value="1.0" step="0.01" min="0.01" max="100">
            </div>
                    <div class="form-group" style="display: flex; align-items: flex-end;">
                        <button class="btn-secondary" onclick="saveGearRatio()" style="width: 100%; padding: 8px;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
                </div>
            </div>

            <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
            <div class="button-group">
                <button class="btn-primary" onclick="moveMotor()">üöÄ –°—Ç–∞—Ä—Ç</button>
                <button class="btn-danger" onclick="stopMotor()">‚èπÔ∏è –°—Ç–æ–ø</button>
                <button class="btn-success" onclick="resetPosition()">üîÑ –°–±—Ä–æ—Å</button>
            </div>

            <!-- –ö—Ä—É–≥–æ–≤–æ–µ –º–µ–Ω—é —Å —Å–µ–≥–º–µ–Ω—Ç–∞–º–∏ (–ø–∏—Ü—Ü–∞) -->
            <h3 style="margin-top: 20px;">üîÑ –ü–æ–≤–æ—Ä–æ—Ç—ã –ø–æ —É–≥–ª–∞–º</h3>
            <div class="angle-circle-container">
                <!-- –¶–µ–Ω—Ç—Ä —Å —Ç–µ–∫—É—â–µ–π –ø–æ–∑–∏—Ü–∏–µ–π -->
                <div class="angle-center">
                    <div class="angle-center-label">–ü–æ–∑–∏—Ü–∏—è</div>
                    <div class="angle-center-value" id="angle-position">0¬∞</div>
        </div>

                <!-- –°–µ–≥–º–µ–Ω—Ç—ã (16 —à—Ç—É–∫ –ø–æ 22.5¬∞ –∫–∞–∂–¥—ã–π) -->
                <ul class="angle-circle">
                    <li class="angle-segment"><button onclick="moveAngleNew(0)">0¬∞</button></li>
                    <li class="angle-segment"><button onclick="moveAngleNew(22.5)">+22.5¬∞</button></li>
                    <li class="angle-segment"><button onclick="moveAngleNew(45)">+45¬∞</button></li>
                    <li class="angle-segment"><button onclick="moveAngleNew(67.5)">+67.5¬∞</button></li>
                    <li class="angle-segment"><button onclick="moveAngleNew(90)">+90¬∞</button></li>
                    <li class="angle-segment"><button onclick="moveAngleNew(112.5)">+112.5¬∞</button></li>
                    <li class="angle-segment"><button onclick="moveAngleNew(135)">+135¬∞</button></li>
                    <li class="angle-segment"><button onclick="moveAngleNew(157.5)">+157.5¬∞</button></li>
                    <li class="angle-segment"><button onclick="moveAngleNew(180)">¬±180¬∞</button></li>
                    <li class="angle-segment negative"><button onclick="moveAngleNew(-157.5)">-157.5¬∞</button></li>
                    <li class="angle-segment negative"><button onclick="moveAngleNew(-135)">-135¬∞</button></li>
                    <li class="angle-segment negative"><button onclick="moveAngleNew(-112.5)">-112.5¬∞</button></li>
                    <li class="angle-segment negative"><button onclick="moveAngleNew(-90)">-90¬∞</button></li>
                    <li class="angle-segment negative"><button onclick="moveAngleNew(-67.5)">-67.5¬∞</button></li>
                    <li class="angle-segment negative"><button onclick="moveAngleNew(-45)">-45¬∞</button></li>
                    <li class="angle-segment negative"><button onclick="moveAngleNew(-22.5)">-22.5¬∞</button></li>
                </ul>
                
                <!-- –Ø–†–õ–´–ö–ò –°–ù–ê–†–£–ñ–ò –ö–†–£–ì–ê -->
                <div class="angle-label label-0">0¬∞</div>
                <div class="angle-label label-22-5">+22.5¬∞</div>
                <div class="angle-label label-45">+45¬∞</div>
                <div class="angle-label label-67-5">+67.5¬∞</div>
                <div class="angle-label label-90">+90¬∞</div>
                <div class="angle-label label-112-5">+112.5¬∞</div>
                <div class="angle-label label-135">+135¬∞</div>
                <div class="angle-label label-157-5">+157.5¬∞</div>
                <div class="angle-label label-180">¬±180¬∞</div>
                <div class="angle-label negative label-minus-157-5">-157.5¬∞</div>
                <div class="angle-label negative label-minus-135">-135¬∞</div>
                <div class="angle-label negative label-minus-112-5">-112.5¬∞</div>
                <div class="angle-label negative label-minus-90">-90¬∞</div>
                <div class="angle-label negative label-minus-67-5">-67.5¬∞</div>
                <div class="angle-label negative label-minus-45">-45¬∞</div>
                <div class="angle-label negative label-minus-22-5">-22.5¬∞</div>
            </div>

            <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
            <div id="message" class="message"></div>
            
        </div>
            <!-- –ö–æ–Ω–µ—Ü –≤–∫–ª–∞–¥–∫–∏ –®–∞–≥–æ–≤—ã–π –¥–≤–∏–≥–∞—Ç–µ–ª—å -->
        
            <!-- –í–∫–ª–∞–¥–∫–∞ 2: –°–æ–ª–µ–Ω–æ–∏–¥ -->
            <div id="tab-solenoid" class="tab-content">

            <!-- –î–∞—Ç—á–∏–∫–∏ –•–æ–ª–ª–∞ -->
        <div class="status-card">
                <h2>üß≤ –î–∞—Ç—á–∏–∫–∏ –•–æ–ª–ª–∞</h2>
                <div class="status-grid">
                    <div class="status-item">
                        <label>–î–∞—Ç—á–∏–∫ 1</label>
                        <div class="value" id="hall-sensor1">‚ùå –ù–ï–¢ –ú–ê–ì–ù–ò–¢–ê</div>
                    </div>
                    <div class="status-item">
                        <label>–î–∞—Ç—á–∏–∫ 2</label>
                        <div class="value" id="hall-sensor2">‚ùå –ù–ï–¢ –ú–ê–ì–ù–ò–¢–ê</div>
                    </div>
                </div>
            </div>

            <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ–ª–µ–Ω–æ–∏–¥–æ–º -->
            <div class="control-section">
                <h3>üîå –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∏—Å—Ç–∞–±–∏–ª—å–Ω—ã–º —Å–æ–ª–µ–Ω–æ–∏–¥–æ–º</h3>
                <div class="form-group">
                    <label for="solenoid_duration">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏–º–ø—É–ª—å—Å–∞ (–º—Å)</label>
                    <input type="number" id="solenoid_duration" value="100" min="50" max="500" step="10">
                </div>
                <div class="button-group">
                    <button class="btn-success" onclick="switchSolenoidA()">üîå –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ A</button>
                    <button class="btn-primary" onclick="switchSolenoidB()">üîå –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ B</button>
                </div>
                <div class="status-item" style="margin-top: 10px;">
                    <label>–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–ª–µ–Ω–æ–∏–¥–∞</label>
                    <div class="value" id="solenoid-state">unknown</div>
                </div>
                <div class="status-item" style="margin-top: 10px;">
                    <label>–¢–æ–∫ —á–µ—Ä–µ–∑ –æ–±–º–æ—Ç–∫—É</label>
                    <div class="value" id="solenoid-current">0 mA</div>
                </div>
                <div class="status-item" style="margin-top: 10px;">
                    <label>–°—Ç–∞—Ç—É—Å –≤–∫–ª—é—á–µ–Ω–∏—è (ENA)</label>
                    <div class="value" id="solenoid-enabled">–í—ã–∫–ª—é—á–µ–Ω</div>
                </div>
            </div>

            <!-- –†—É—á–Ω–æ–π —Ä–µ–∂–∏–º —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ø–æ–ª–æ–∂–µ–Ω–∏—è -->
            <div class="control-section">
                <h3>üîß –†—É—á–Ω–æ–π —Ä–µ–∂–∏–º —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ø–æ–ª–æ–∂–µ–Ω–∏—è</h3>
                <div style="background: #f0f7ff; padding: 10px; border-radius: 6px; margin-bottom: 15px; font-size: 0.9em;">
                    <strong>üí° –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:</strong><br>
                    ‚Ä¢ –°–æ–ª–µ–Ω–æ–∏–¥: +90¬∞ (A) –∏–ª–∏ -90¬∞ (B)<br>
                    ‚Ä¢ –ú–∞–≥–Ω–∏—Ç –Ω–∞ –≤–∞–ª—É: –¥–∞—Ç—á–∏–∫–∏ –ª–æ–≤—è—Ç —Å–µ–≤–µ—Ä<br>
                    ‚Ä¢ –î–∞—Ç—á–∏–∫ 1 ‚Üí –º–∞–≥–Ω–∏—Ç –≤ –ø–æ–∑–∏—Ü–∏–∏ A (+90¬∞)<br>
                    ‚Ä¢ –î–∞—Ç—á–∏–∫ 2 ‚Üí –º–∞–≥–Ω–∏—Ç –≤ –ø–æ–∑–∏—Ü–∏–∏ B (-90¬∞)
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="manual_direction">–ö—É–¥–∞ –∫—Ä—É—Ç–∏—Ç—å?</label>
                        <select id="manual_direction">
                            <option value="0">–í –ø–æ–∑–∏—Ü–∏—é A (+90¬∞) ‚Üí –î–∞—Ç—á–∏–∫ 1</option>
                            <option value="1">–í –ø–æ–∑–∏—Ü–∏—é B (-90¬∞) ‚Üí –î–∞—Ç—á–∏–∫ 2</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="manual_timeout">–¢–∞–π–º–∞—É—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ (–º—Å)</label>
                        <input type="number" id="manual_timeout" value="500" min="100" max="2000" step="50">
                    </div>
                </div>
                <div class="button-group">
                    <button class="btn-success" onclick="manualSwitchWithCheck()">üîß –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
                </div>
                <div class="status-item" style="margin-top: 10px;">
                    <label>–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø—Ä–æ–≤–µ—Ä–∫–∏</label>
                    <div class="value" id="manual-check-result">-</div>
                </div>
            </div>

            <!-- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–µ—Å—Ç -->
            <div class="control-section">
                <h3>üß™ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–µ—Å—Ç</h3>
                <div style="background: #fff7e6; padding: 10px; border-radius: 6px; margin-bottom: 15px; font-size: 0.9em;">
                    <strong>‚öôÔ∏è –¢–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:</strong><br>
                    ‚Ä¢ A ‚Üí B ‚Üí A ‚Üí B (–±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª)<br>
                    ‚Ä¢ –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –¥–∞—Ç—á–∏–∫<br>
                    ‚Ä¢ –ï—Å–ª–∏ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª ‚Üí –º–µ–Ω—è–µ—Ç –ø–æ–ª—è—Ä–Ω–æ—Å—Ç—å –∏ –ø—Ä–æ–±—É–µ—Ç —Å–Ω–æ–≤–∞
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px;">
                        <div class="form-group" style="margin: 0;">
                            <label for="test_duration" style="font-size: 0.85em; line-height: 1.3;">–ó–∞–¥–µ—Ä–∂–∫–∞<br>–º–µ–∂–¥—É –ø–æ–≤–æ—Ä–æ—Ç–∞–º–∏ (–º—Å)</label>
                            <input type="number" id="test_duration" value="1000" min="100" max="10000" step="100" style="width: 100%;">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label for="test_cooldown" style="font-size: 0.85em; line-height: 1.3;">–í—Ä–µ–º—è –æ—Ç–¥—ã—Ö–∞<br>(–º—Å, –∑–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–≥—Ä–µ–≤–∞)</label>
                            <input type="number" id="test_cooldown" value="0" min="0" max="60000" step="100" style="width: 100%;">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label for="test_max_attempts" style="font-size: 0.85em; line-height: 1.3;">–ú–∞–∫—Å. –ø–æ–ø—ã—Ç–æ–∫<br>–Ω–∞ –ø–æ–≤–æ—Ä–æ—Ç</label>
                            <input type="number" id="test_max_attempts" value="3" min="1" max="10" style="width: 100%;">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label for="test_max_failures" style="font-size: 0.85em; line-height: 1.3;">–ú–∞–∫—Å. –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö<br>–Ω–µ—É–¥–∞—á (–∑–∞—â–∏—Ç–∞ –æ—Ç –∫–ª–∏–Ω–∞)</label>
                            <input type="number" id="test_max_failures" value="5" min="1" max="20" style="width: 100%;">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label for="test_max_time" style="font-size: 0.85em; line-height: 1.3;">–ú–∞–∫—Å. –≤—Ä–µ–º—è —Ç–µ—Å—Ç–∞<br>(—Å–µ–∫, 0 = –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ)</label>
                            <input type="number" id="test_max_time" value="0" min="0" max="3600" step="1" style="width: 100%;">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label for="test_max_cycles" style="font-size: 0.85em; line-height: 1.3;">–ú–∞–∫—Å. –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ<br>—Ü–∏–∫–ª–æ–≤ (0 = –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ)</label>
                            <input type="number" id="test_max_cycles" value="0" min="0" max="10000" step="1" style="width: 100%;">
                        </div>
                    </div>
                </div>
                <div class="button-group">
                    <button class="btn-success" onclick="startSolenoidTest()">üß™ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç</button>
                    <button class="btn-danger" onclick="stopSolenoidTest()">‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ—Å—Ç</button>
                </div>
                <div class="status-item" style="margin-top: 10px;">
                    <label>–°—Ç–∞—Ç—É—Å —Ç–µ—Å—Ç–∞</label>
                    <div class="value" id="test-status">‚è∏Ô∏è –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</div>
                </div>
                <div class="status-item" style="margin-top: 10px;">
                    <label>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</label>
                    <div style="font-size: 0.9em; color: #666;">–¢–µ—Å—Ç –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ —Ñ–æ–Ω–µ, —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ –ª–æ–≥–∞—Ö. –ú–æ–∂–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç.</div>
                </div>
            </div>
            
            </div>
            <!-- –ö–æ–Ω–µ—Ü –≤–∫–ª–∞–¥–∫–∏ –°–æ–ª–µ–Ω–æ–∏–¥ -->
              <!-- –û–±—â–µ–µ –æ–∫–Ω–æ –ª–æ–≥–æ–≤ (–≤–Ω—É—Ç—Ä–∏ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ container, –ø–æ—Å–ª–µ content) -->
        <div class="content" style="border-top: 1px solid #e0e0e0; padding-top: 20px; margin-top: 20px;">
            <div class="status-card">
                <h2>üìã –õ–æ–≥–∏ —Å–∏—Å—Ç–µ–º—ã</h2>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <p style="margin: 0; color: #666;">–î–∞–Ω–Ω—ã–µ –º–∏–∫—Ä–æ–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞</p>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn-secondary" onclick="downloadLogs()" style="padding: 5px 10px; font-size: 0.9em;">–°–∫–∞—á–∞—Ç—å</button>
                        <button class="btn-secondary" onclick="clearLogs()" style="padding: 5px 10px; font-size: 0.9em;">–û—á–∏—Å—Ç–∏—Ç—å</button>
                    </div>
                </div>
                <div id="logs" class="logs-container" style="background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 8px; max-height: 400px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 0.85em; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">
                    <div class="log-line" style="color: #999;">–û–∂–∏–¥–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...</div>
                </div>
            </div>
        </div>
        
    </div>
    <!-- –ö–æ–Ω–µ—Ü –æ—Å–Ω–æ–≤–Ω–æ–≥–æ container -->
        </div>
        

    <script>

        // ============================================================================
        // API –ö–õ–ò–ï–ù–¢ (—Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥ —Å async/await)
        // ============================================================================
        
        const API = {
            async request(endpoint, method = 'GET', data = null) {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    }
                };
                
                if (data && method === 'POST') {
                    options.body = new URLSearchParams(data).toString();
                }
                
                try {
                    const response = await fetch(endpoint, options);
                    const json = await response.json();
                    return json;
                } catch (error) {
                    return {
                        success: false,
                        message: '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message
                    };
                }
            },
            
            // === –û–°–ù–û–í–ù–´–ï API ENDPOINTS ===
            async getStatus() {
                return await this.request('/api/status');
            },
            
            async diagnostic() {
                return await this.request('/api/diagnostic');
            },
            
            async getDetailedDiagnostics() {
                return await this.request('/api/detailed_diagnostics');
            },
            
            async getLogs() {
                return await this.request('/api/logs');
            },
            
            async clearLogs() {
                return await this.request('/api/logs/clear', 'POST');
            },
            async getPresets() {
                return await this.request('/api/presets');
            },
            async applyPreset(preset_id) {
                return await this.request('/api/apply_preset', 'POST', { preset_id });
            },
            
            // === –£–ü–†–ê–í–õ–ï–ù–ò–ï –î–í–ò–ì–ê–¢–ï–õ–ï–ú ===
            async enable() {
                return await this.request('/api/enable', 'POST');
            },

            async disable() {
                return await this.request('/api/disable', 'POST');
            },
            
            async move(params) {
                return await this.request('/api/move', 'POST', params);
            },
            
            async moveAngle(params) {
                return await this.request('/api/move_angle', 'POST', params);
            },
            
            async moveFromCenter(params) {
                return await this.request('/api/move_from_center', 'POST', params);
            },
            
            async stop() {
                return await this.request('/api/stop', 'POST');
            },
            
            async emergencyStop() {
                return await this.request('/api/emergency_stop', 'POST');
            },
            
            async reset() {
                return await this.request('/api/reset', 'POST');
            },
            
            // === –ü–†–ï–°–ï–¢–´ –£–î–ê–õ–ï–ù–´ - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä—É—á–Ω—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É ===
        };
        
        // ============================================================================
        // UI –£–ü–†–ê–í–õ–ï–ù–ò–ï
        // ============================================================================
        
        function showMessage(text, type = 'success') {
            const msg = document.getElementById('message');
            msg.textContent = text;
            msg.className = 'message ' + type + ' show';
            setTimeout(() => msg.classList.remove('show'), 5000);
        }
        
        // ======== –§–æ—Ä–º-—Ö–µ–ª–ø–µ—Ä—ã: —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –¥–µ–±–∞—É–Ω—Å, –∑–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏ ========
        const formState = {
            dirty: new Set(),
            setDirty(id, isDirty) {
                if (isDirty) this.dirty.add(id); else this.dirty.delete(id);
            },
            isDirty(id) { return this.dirty.has(id); }
        };

        function debounce(fn, delay = 400) {
            let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), delay); };
        }

        function setIfNotFocused(id, value) {
            const el = document.getElementById(id);
            if (!el) return;
            if (document.activeElement === el) return; // –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞—Ç—å –≤–æ –≤—Ä–µ–º—è –≤–≤–æ–¥–∞
            if (formState.isDirty(id)) return;         // —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –ø—Ä–∞–≤–∫–∏
            if (value !== undefined && value !== null && value !== '') el.value = value;
        }
        
        function updateStatus(data) {
            if (!data || !data.success || !data.data) return;
            
            const s = data.data;
            
            // –°—Ç–∞—Ç—É—Å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
            document.getElementById('status-init').textContent = s.initialized ? '‚úÖ –î–ê' : '‚ùå –ù–ï–¢';
            document.getElementById('status-init').className = 'value ' + (s.initialized ? 'good' : 'bad');
            
            // –°—Ç–∞—Ç—É—Å –¥—Ä–∞–π–≤–µ—Ä–∞
            document.getElementById('status-enabled').textContent = s.enabled ? '‚úÖ –í–ö–õ' : '‚ùå –í–´–ö–õ';
            document.getElementById('status-enabled').className = 'value ' + (s.enabled ? 'good' : 'bad');
            
            // –î–≤–∏–∂–µ–Ω–∏–µ
            document.getElementById('status-moving').textContent = s.is_moving ? '‚ñ∂Ô∏è –î–ê' : '‚è∏Ô∏è –ù–ï–¢';
            document.getElementById('status-moving').className = 'value ' + (s.is_moving ? 'good' : '');
            
            // –ü–æ–∑–∏—Ü–∏—è (–¢–û–õ–¨–ö–û –®–ê–ì–ò, –ë–ï–ó –ì–†–ê–î–£–°–û–í!)
            document.getElementById('status-position').textContent = s.current_position;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —É–≥–ª–æ–≤–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            const degrees = ((s.current_position % 200) / 200 * 360).toFixed(0);
            const anglePos = document.getElementById('angle-position');
            if (anglePos) {
                anglePos.textContent = degrees + '¬∞';
            }
            
            // –°–∫–æ—Ä–æ—Å—Ç—å
            document.getElementById('status-speed').textContent = s.current_speed.toFixed(2);
            
            // –û—Å—Ç–∞–ª–æ—Å—å
            document.getElementById('status-remaining').textContent = s.steps_remaining;
            
            // –î–∞—Ç—á–∏–∫–∏ –•–æ–ª–ª–∞
            if (s.hall_sensors) {
                const hall1 = s.hall_sensors.sensor1;
                const hall2 = s.hall_sensors.sensor2;
                
                const hall1El = document.getElementById('hall-sensor1');
                const hall2El = document.getElementById('hall-sensor2');
                
                if (hall1El) {
                    hall1El.textContent = hall1.active ? '‚úÖ –ú–ê–ì–ù–ò–¢ –û–ë–ù–ê–†–£–ñ–ï–ù' : '‚ùå –ù–ï–¢ –ú–ê–ì–ù–ò–¢–ê';
                    hall1El.className = 'value ' + (hall1.active ? 'good' : '');
                }
                if (hall2El) {
                    hall2El.textContent = hall2.active ? '‚úÖ –ú–ê–ì–ù–ò–¢ –û–ë–ù–ê–†–£–ñ–ï–ù' : '‚ùå –ù–ï–¢ –ú–ê–ì–ù–ò–¢–ê';
                    hall2El.className = 'value ' + (hall2.active ? 'good' : '');
                }
            }
            
            // –°–æ–ª–µ–Ω–æ–∏–¥
            if (s.solenoid) {
                const solenoidStateEl = document.getElementById('solenoid-state');
                if (solenoidStateEl) {
                    solenoidStateEl.textContent = s.solenoid.state || 'unknown';
                    solenoidStateEl.className = 'value ' + (s.solenoid.switching ? 'bad' : 'good');
                }
                
                const solenoidCurrentEl = document.getElementById('solenoid-current');
                if (solenoidCurrentEl) {
                    const current_mA = s.solenoid.current_mA || 0;
                    solenoidCurrentEl.textContent = current_mA > 0 ? current_mA + ' mA' : '0 mA (–≤—ã–∫–ª—é—á–µ–Ω)';
                    solenoidCurrentEl.className = 'value ' + (current_mA > 0 ? 'good' : '');
                }
                
                const solenoidEnabledEl = document.getElementById('solenoid-enabled');
                if (solenoidEnabledEl) {
                    const enabled = s.solenoid.enabled || false;
                    solenoidEnabledEl.textContent = enabled ? '–í–∫–ª—é—á–µ–Ω (ENA=HIGH)' : '–í—ã–∫–ª—é—á–µ–Ω (ENA=LOW)';
                    solenoidEnabledEl.className = 'value ' + (enabled ? 'good' : '');
                }
                
                const testStatusEl = document.getElementById('test-status');
                if (testStatusEl) {
                    testStatusEl.textContent = s.solenoid.testing ? 'üîÑ –ó–∞–ø—É—â–µ–Ω' : '‚è∏Ô∏è –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω';
                    testStatusEl.className = 'value ' + (s.solenoid.testing ? 'good' : '');
                }
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—è —Ñ–æ—Ä–º—ã —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ (–±–µ–∑ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏ –≤–æ –≤—Ä–µ–º—è –≤–≤–æ–¥–∞)
            if (s.settings) {
                setIfNotFocused('max_speed', s.settings.max_speed);
                setIfNotFocused('acceleration', s.settings.acceleration);
                setIfNotFocused('deceleration', s.settings.deceleration);
                setIfNotFocused('driver_current', s.settings.current_mA);
                setIfNotFocused('driver_hold_mult', s.settings.hold_multiplier);
                setIfNotFocused('steps_per_rev', s.settings.steps_per_rev);
                setIfNotFocused('gear_ratio', s.settings.gear_ratio || 1.0); // –ü–µ—Ä–µ–¥–∞—Ç–æ—á–Ω–æ–µ —á–∏—Å–ª–æ!
                
                // select –Ω–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è –ø–µ—á–∞—Ç—å—é, –Ω–æ –≤—Å—ë –∂–µ –æ–±–Ω–æ–≤–∏–º, –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–∏—à–ª–æ
                if (s.settings.microsteps !== undefined && s.settings.microsteps !== null) {
                    const el = document.getElementById('driver_microsteps');
                    if (el && document.activeElement !== el && !formState.isDirty('driver_microsteps')) el.value = s.settings.microsteps;
                }
            }
        }

        // ======== –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫ ========
        function switchTab(tabName, buttonElement) {
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(tab => tab.classList.remove('active'));
            
            // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—É—é –≤–∫–ª–∞–¥–∫—É
            const targetTab = document.getElementById('tab-' + tabName);
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
            if (buttonElement) {
                buttonElement.classList.add('active');
            }
        }

        // ======== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–ª—É—à–∞—Ç–µ–ª–µ–π –≤–≤–æ–¥–∞ –∏ –∞–≤—Ç–æ-—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ ========
        const fieldsToGuard = [
            'driver_current', 'driver_hold_mult', 'driver_microsteps',
            'max_speed', 'acceleration', 'deceleration', 'steps_per_rev',
            // —Ç–∞–∫–∂–µ –∑–∞—â–∏—Ç–∏–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–≤–∏–∂–µ–Ω–∏—è, —á—Ç–æ–±—ã –Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞–ª–∏—Å—å –≤–æ –≤—Ä–µ–º—è –≤–≤–æ–¥–∞
            'steps', 'direction'
        ];

        const debouncedSaveSettings = debounce(async () => {
            // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥—Ä–∞–π–≤–µ—Ä–∞/–∫–∏–Ω–µ–º–∞—Ç–∏–∫–∏
            const payload = {
                current_mA: document.getElementById('driver_current').value,
                hold_multiplier: document.getElementById('driver_hold_mult').value,
                microsteps: document.getElementById('driver_microsteps').value,
                max_speed: document.getElementById('max_speed').value,
                acceleration: document.getElementById('acceleration').value,
                deceleration: document.getElementById('deceleration').value,
                steps_per_rev: document.getElementById('steps_per_rev').value
            };
            try {
                await fetch('/api/save_settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams(payload).toString()
                });
            } catch (_) { /* —Ç–∏—Ö–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏ –ø—Ä–∏ –∞–≤—Ç–æ-—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ */ }
        }, 600);

        function attachGuards() {
            fieldsToGuard.forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;

                // –ø–æ–º–µ—á–∞–µ–º –ø–æ–ª–µ –≥—Ä—è–∑–Ω—ã–º –ø—Ä–∏ –≤–≤–æ–¥–µ (–ë–ï–ó –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è!)
                el.addEventListener('input', () => {
                    formState.setDirty(id, true);
                    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞ "Custom" –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤—Ä—É—á–Ω—É—é
                    if (['driver_current', 'driver_hold_mult', 'driver_microsteps', 
                         'max_speed', 'acceleration', 'deceleration', 'steps_per_rev'].includes(id)) {
                        switchToCustomOnEdit();
                    }
                });

                // –ü—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Ñ–æ–∫—É—Å–∞ –ù–ï —Å–æ—Ö—Ä–∞–Ω—è–µ–º - —Ç–æ–ª—å–∫–æ –ø–æ –∫–Ω–æ–ø–∫–µ!
                // –ù–ï —Å–Ω–∏–º–∞–µ–º dirty —Ñ–ª–∞–≥ - –æ–Ω —Å–Ω–∏–º–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏
                el.addEventListener('blur', () => {
                    // –ù–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –ø–æ –∫–Ω–æ–ø–∫–µ
                });
            });
        }

        // ======== –ü—Ä–µ—Å–µ—Ç—ã: –∑–∞–≥—Ä—É–∑–∫–∞, –≤—ã–±–æ—Ä, –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ ========
        let presetData = [];  // –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –ø—Ä–µ—Å–µ—Ç–æ–≤
        
        async function loadPresets() {
            const sel = document.getElementById('preset_select');
            if (!sel) return;
            const res = await API.getPresets();
            if (!res || !res.success || !res.data) return;
            
            presetData = res.data;  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
            
            sel.innerHTML = '';
            
            // –î–æ–±–∞–≤–ª—è–µ–º "Custom" –≤ –Ω–∞—á–∞–ª–æ
            const customOpt = document.createElement('option');
            customOpt.value = 'custom';
            customOpt.textContent = 'üîß Custom (—Å–≤–æ–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏)';
            sel.appendChild(customOpt);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ—Å–µ—Ç—ã
            res.data.forEach(p => {
                const opt = document.createElement('option');
                opt.value = String(p.id);
                opt.textContent = p.name + ` (${p.current_mA}mA, ${p.microsteps}¬µ)`;
                sel.appendChild(opt);
            });
            
            // –ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –ø—Ä–µ—Å–µ—Ç–∞
            sel.addEventListener('change', () => {
                if (sel.value !== 'custom') {
                    fillFromPresetLocal();
                }
            });
            
            // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—ã–±–∏—Ä–∞–µ–º Custom (—Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å ESP32)
            sel.value = 'custom';
        }

        function fillFromPresetLocal() {
            const sel = document.getElementById('preset_select');
            const id = parseInt(sel.value || '0', 10);
            
            const p = presetData.find(x => x.id === id);
            if (!p) return;
            
            // –ó–ê–ü–û–õ–ù–Ø–ï–ú –í–°–ï –ü–û–õ–Ø (–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ, –∏–≥–Ω–æ—Ä–∏—Ä—É—è dirty state)
            document.getElementById('driver_current').value = p.current_mA;
            document.getElementById('driver_microsteps').value = p.microsteps;
            document.getElementById('max_speed').value = p.max_speed;
            document.getElementById('acceleration').value = p.acceleration;
            document.getElementById('deceleration').value = p.deceleration;
            document.getElementById('driver_hold_mult').value = p.hold_mult;
            document.getElementById('steps_per_rev').value = p.steps_per_rev;
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º dirty state –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–µ–π
            fieldsToGuard.forEach(id => formState.setDirty(id, false));
            
            showMessage(`‚úÖ –ü—Ä–µ—Å–µ—Ç "${p.name}" –∑–∞–≥—Ä—É–∂–µ–Ω!`, 'success');
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ "Custom" –ø—Ä–∏ —Ä—É—á–Ω–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏
        function switchToCustomOnEdit() {
            const sel = document.getElementById('preset_select');
            if (sel && sel.value !== 'custom') {
                sel.value = 'custom';
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–ª–µ–π (–∏–≥–Ω–æ—Ä–∏—Ä—É—è dirty state)
        function forceUpdateField(id, value) {
            const el = document.getElementById(id);
            if (!el) return;
            if (value !== undefined && value !== null && value !== '') {
                el.value = value;
                formState.setDirty(id, false); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º dirty state
            }
        }

        async function applyPreset() {
            const sel = document.getElementById('preset_select');
            const id = parseInt(sel.value || '0', 10);
            
            // –¢–û–õ–¨–ö–û –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–µ—Å–µ—Ç–∞ (–ë–ï–ó —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ EEPROM!)
            const res = await API.getPresets();
            if (!res.success || !res.data) {
                showMessage('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ—Å–µ—Ç–æ–≤', 'error');
                return;
            }
            
            const preset = res.data.find(p => p.id === id);
            if (!preset) {
                showMessage('‚ùå –ü—Ä–µ—Å–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                return;
            }
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –∏–∑ –ø—Ä–µ—Å–µ—Ç–∞
            forceUpdateField('driver_current', preset.current_mA);
            forceUpdateField('driver_hold_mult', preset.hold_mult);
            forceUpdateField('driver_microsteps', preset.microsteps);
            forceUpdateField('max_speed', preset.max_speed);
            forceUpdateField('acceleration', preset.acceleration);
            forceUpdateField('deceleration', preset.deceleration);
            forceUpdateField('steps_per_rev', preset.steps_per_rev);
            
            showMessage('‚úÖ –ü—Ä–µ—Å–µ—Ç "' + preset.name + '" –∑–∞–≥—Ä—É–∂–µ–Ω –≤ —Ñ–æ—Ä–º—É. –ù–∞–∂–º–∏—Ç–µ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏" –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è.', 'success');
        }
        
        // ============================================================================
        // –ö–û–ú–ê–ù–î–´
        // ============================================================================
        
        async function moveMotor() {
            // –¢–û–õ–¨–ö–û –î–í–ò–ñ–ï–ù–ò–ï! –ù–µ –≤–∫–ª—é—á–∞–µ–º –º–æ—Ç–æ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
            let steps = parseInt(document.getElementById('steps').value);
            const direction = document.getElementById('direction').value;
            
            // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: backward = –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ —à–∞–≥–∏!
            if (direction === 'backward') {
                steps = -steps;
            }
            
            const params = {
                steps: steps, // –ü–µ—Ä–µ–¥–∞—ë–º —Å–æ –∑–Ω–∞–∫–æ–º!
                max_speed: document.getElementById('max_speed').value,
                acceleration: document.getElementById('acceleration').value,
                deceleration: document.getElementById('deceleration').value,
                driver_current: document.getElementById('driver_current').value,
                driver_microsteps: document.getElementById('driver_microsteps').value,
                mech_steps_per_rev: document.getElementById('steps_per_rev').value
            };
            
            const result = await API.move(params);
            
            if (result.success) {
                showMessage(result.message, 'success');
            } else {
                showMessage(result.message, 'error');
            }
            
            updateStatusLoop();
        }
        
        async function stopMotor() {
            const result = await API.stop();
            showMessage(result.message, result.success ? 'success' : 'error');
            updateStatusLoop();
        }
        
        async function enableMotor() {
            const result = await API.enable();
            showMessage(result.message || '‚úÖ –ú–æ—Ç–æ—Ä –≤–∫–ª—é—á–µ–Ω (—É–¥–µ—Ä–∂–∞–Ω–∏–µ)', result.success ? 'success' : 'error');
            updateStatusLoop();
        }

        async function disableMotor() {
            const result = await API.disable();
            showMessage(result.message || '‚ö° –ú–æ—Ç–æ—Ä –≤—ã–∫–ª—é—á–µ–Ω', result.success ? 'success' : 'error');
            updateStatusLoop();
        }

        async function resetPosition() {
            const result = await API.reset();
            showMessage(result.message, result.success ? 'success' : 'error');
            updateStatusLoop();
        }

        // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: moveAngleNew(signedAngle)
        // signedAngle: +45 = –ü–û —á–∞—Å–æ–≤–æ–π, -45 = –ü–†–û–¢–ò–í —á–∞—Å–æ–≤–æ–π, 0 –∏–ª–∏ ¬±180 = –æ—Å–æ–±—ã–µ
        async function moveAngleNew(signedAngle) {
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —à–∞–≥–æ–≤: 200 —à–∞–≥–æ–≤ = 360¬∞
            const stepsPerFullRotation = 200; // –ë–∞–∑–æ–≤—ã–µ —à–∞–≥–∏ –º–æ—Ç–æ—Ä–∞
            const gearRatio = parseFloat(document.getElementById('gear_ratio').value) || 1.0;
            
            // –£—á–∏—Ç—ã–≤–∞–µ–º –ø–µ—Ä–µ–¥–∞—Ç–æ—á–Ω–æ–µ —á–∏—Å–ª–æ!
            const steps = Math.round((signedAngle / 360.0) * stepsPerFullRotation * gearRatio);
            
            // steps —É–∂–µ —Å–æ –∑–Ω–∞–∫–æ–º! (+ –∏–ª–∏ -)
            const params = {
                steps: steps,
                max_speed: document.getElementById('max_speed').value,
                acceleration: document.getElementById('acceleration').value,
                deceleration: document.getElementById('deceleration').value
            };
            
            const result = await API.move(params);
            showMessage(result.message, result.success ? 'success' : 'error');
            updateStatusLoop();
        }

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ–ª–µ–Ω–æ–∏–¥–æ–º
        async function switchSolenoidA() {
            const duration = parseInt(document.getElementById('solenoid_duration').value) || 100;
            try {
                const response = await fetch('/api/solenoid/switch_a', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ duration: duration }).toString()
                });
                const result = await response.json();
                showMessage(result.message || 'üîå –°–æ–ª–µ–Ω–æ–∏–¥ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ A', result.success ? 'success' : 'error');
                updateStatusLoop();
            } catch (error) {
                showMessage('‚ùå –û—à–∏–±–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ–ª–µ–Ω–æ–∏–¥–æ–º: ' + error.message, 'error');
            }
        }

        async function switchSolenoidB() {
            const duration = parseInt(document.getElementById('solenoid_duration').value) || 100;
            try {
                const response = await fetch('/api/solenoid/switch_b', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ duration: duration }).toString()
                });
                const result = await response.json();
                showMessage(result.message || 'üîå –°–æ–ª–µ–Ω–æ–∏–¥ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ B', result.success ? 'success' : 'error');
            updateStatusLoop();
            } catch (error) {
                showMessage('‚ùå –û—à–∏–±–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ–ª–µ–Ω–æ–∏–¥–æ–º: ' + error.message, 'error');
            }
        }

        async function manualSwitchWithCheck() {
            const direction = parseInt(document.getElementById('manual_direction').value);
            // –î–∞—Ç—á–∏–∫ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é: A (0) ‚Üí –¥–∞—Ç—á–∏–∫ 1, B (1) ‚Üí –¥–∞—Ç—á–∏–∫ 2
            const hall_sensor = direction === 0 ? 1 : 2;
            const duration = parseInt(document.getElementById('solenoid_duration').value) || 100;
            const timeout = parseInt(document.getElementById('manual_timeout').value) || 500;
            
            try {
                const response = await fetch('/api/solenoid/switch_with_check', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({
                        direction: direction,
                        hall_sensor: hall_sensor,
                        duration: duration,
                        timeout: timeout
                    }).toString()
                });
                const result = await response.json();
                
                const resultEl = document.getElementById('manual-check-result');
                if (resultEl) {
                    resultEl.textContent = result.success ? '‚úÖ –î–∞—Ç—á–∏–∫ —Å—Ä–∞–±–æ—Ç–∞–ª' : '‚ùå –î–∞—Ç—á–∏–∫ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª';
                    resultEl.className = 'value ' + (result.success ? 'good' : 'bad');
                }
                
                showMessage(result.message || (result.success ? '‚úÖ –î–∞—Ç—á–∏–∫ —Å—Ä–∞–±–æ—Ç–∞–ª' : '‚ùå –î–∞—Ç—á–∏–∫ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª'), 
                           result.success ? 'success' : 'error');
                updateStatusLoop();
            } catch (error) {
                showMessage('‚ùå –û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }

        async function startSolenoidTest() {
            const direction = 2; // –í—Å–µ–≥–¥–∞ A‚áÑB –ø–æ –æ—á–µ—Ä–µ–¥–∏
            const test_duration = parseInt(document.getElementById('test_duration').value);
            const cooldown_ms = parseInt(document.getElementById('test_cooldown').value) || 0;
            const max_attempts = parseInt(document.getElementById('test_max_attempts').value) || 3;
            const max_failures = parseInt(document.getElementById('test_max_failures').value) || 5;
            const max_time_sec = parseInt(document.getElementById('test_max_time').value) || 0;
            const max_cycles = parseInt(document.getElementById('test_max_cycles').value) || 0;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ —Ç–µ—Å—Ç–∞
            showMessage('üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞...', 'info');
            
            try {
                const params = new URLSearchParams({
                    direction: direction,
                    test_duration: test_duration,
                    cooldown_ms: cooldown_ms,
                    max_attempts: max_attempts,
                    max_failures: max_failures
                });
                
                if (max_time_sec > 0) {
                    params.append('max_time_sec', max_time_sec);
                }
                if (max_cycles > 0) {
                    params.append('max_cycles', max_cycles);
                }
                
                const response = await fetch('/api/solenoid/start_test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: params.toString()
                });
                const result = await response.json();
                showMessage(result.message || 'üß™ –¢–µ—Å—Ç –∑–∞–ø—É—â–µ–Ω', result.success ? 'success' : 'error');
                updateStatusLoop();
            } catch (error) {
                showMessage('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–∞: ' + error.message, 'error');
            }
        }

        async function stopSolenoidTest() {
            try {
                const response = await fetch('/api/solenoid/stop_test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
                });
                const result = await response.json();
                showMessage(result.message || '‚èπÔ∏è –¢–µ—Å—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω', result.success ? 'success' : 'error');
                updateStatusLoop();
            } catch (error) {
                showMessage('‚ùå –û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ç–µ—Å—Ç–∞: ' + error.message, 'error');
            }
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–µ—Ä–µ–¥–∞—Ç–æ—á–Ω–æ–≥–æ —á–∏—Å–ª–∞ –≤ EEPROM
        async function saveGearRatio() {
            const gearRatio = parseFloat(document.getElementById('gear_ratio').value);
            
            if (isNaN(gearRatio) || gearRatio <= 0) {
                showMessage('‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –ø–µ—Ä–µ–¥–∞—Ç–æ—á–Ω–æ–µ —á–∏—Å–ª–æ!', 'error');
                return;
            }
            
            const params = new URLSearchParams();
            params.append('gear_ratio', gearRatio);
            
            const result = await API.request('/api/save_gear_ratio', 'POST', params.toString());
            showMessage(result.message || '‚úÖ –ü–µ—Ä–µ–¥–∞—Ç–æ—á–Ω–æ–µ —á–∏—Å–ª–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!', result.success ? 'success' : 'error');
        }
        
        // –°—Ç–∞—Ä–∞—è —Ñ—É–Ω–∫—Ü–∏—è (–æ—Å—Ç–∞–≤–ª—è–µ–º –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
        async function moveAngle(angle, direction) {
            const stepsPerFullRotation = 200;
            let steps = Math.round((angle / 360.0) * stepsPerFullRotation);
            if (direction === 'backward') {
                steps = -steps;
            }
            const params = {
                steps: steps,
                max_speed: document.getElementById('max_speed').value,
                acceleration: document.getElementById('acceleration').value,
                deceleration: document.getElementById('deceleration').value
            };
            const result = await API.move(params);
            showMessage(result.message, result.success ? 'success' : 'error');
            updateStatusLoop();
        }

        // ‚ùå moveFromCenter —É–¥–∞–ª—ë–Ω - –æ—Å—Ç–∞–≤–ª–µ–Ω—ã —Ç–æ–ª—å–∫–æ –±–∞–∑–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

        // –§—É–Ω–∫—Ü–∏—è –ø—Ä–µ—Å–µ—Ç–æ–≤ —É–¥–∞–ª–µ–Ω–∞ - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä—É—á–Ω—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

        // –ê–≤–∞—Ä–∏–π–Ω–∞—è –æ—Ç–º–µ–Ω–∞
        async function emergencyStop() {
            if (confirm('üö® –í–´ –£–í–ï–†–ï–ù–´? –≠—Ç–æ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –æ–±–µ—Å—Ç–æ—á–∏—Ç –º–æ—Ç–æ—Ä!')) {
                const result = await API.emergencyStop();
                showMessage(result.message, result.success ? 'success' : 'error');
                updateStatusLoop();
            }
        }

        // ‚ùå –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞, VACTUAL –∏ STEP/DIR —Ñ—É–Ω–∫—Ü–∏–∏ —É–¥–∞–ª–µ–Ω—ã - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ Motion Controller

        async function saveSettings() {
            showMessage('üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫...', 'success');
            try {
                const params = {
                    current_mA: document.getElementById('driver_current').value,
                    hold_multiplier: document.getElementById('driver_hold_mult').value,
                    microsteps: document.getElementById('driver_microsteps').value,
                    max_speed: document.getElementById('max_speed').value,
                    acceleration: document.getElementById('acceleration').value,
                    deceleration: document.getElementById('deceleration').value,
                    steps_per_rev: document.getElementById('steps_per_rev').value
                };

                const response = await fetch('/api/save_settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams(params).toString()
                });

                const result = await response.json();
                showMessage(result.message, result.success ? 'success' : 'error');

                if (result.success) {
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º dirty state –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–µ–π –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
                    ['driver_current', 'driver_hold_mult', 'driver_microsteps',
                     'max_speed', 'acceleration', 'deceleration', 'steps_per_rev'].forEach(id => {
                        formState.setDirty(id, false);
                    });
                }
            } catch (error) {
                showMessage('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫: ' + error.message, 'error');
            }
        }
        
        // ============================================================================
        // –ê–í–¢–û-–û–ë–ù–û–í–õ–ï–ù–ò–ï –°–¢–ê–¢–£–°–ê
        // ============================================================================
        
        let statusInterval = null;
        
        async function updateStatusLoop() {
            const result = await API.getStatus();
            if (result.success) {
                updateStatus(result);
            }
        }
        
        // –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞–∂–¥—ã–µ 500ms
        statusInterval = setInterval(updateStatusLoop, 500);
        
        // –ü–µ—Ä–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ä–∞–∑—É
        updateStatusLoop();
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞—â–∏—Ç –¥–ª—è –ø–æ–ª–µ–π —Ñ–æ—Ä–º—ã
        attachGuards();
        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ—Å–µ—Ç–æ–≤ –¥–ª—è –µ–¥–∏–Ω–æ–≥–æ –º–µ–Ω—é
        loadPresets();
        
        // === –õ–û–ì–ò ===
        let logsInterval = null;
        
        // –§—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ª–æ–≥–æ–≤
        function renderLogs(logsElement, logData) {
            if (!logData || logData.trim() === '') {
                logsElement.innerHTML = '<div class="log-line log-warning">–û–∂–∏–¥–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...</div>';
                return;
            }
            
            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –ª–æ–≥–∏ –∫–∞–∫ –∫–æ–Ω—Å–æ–ª—å - —Ä–∞–∑–±–∏–≤–∞–µ–º –ø–æ —Å—Ç—Ä–æ–∫–∞–º
            const lines = logData.split('\n').filter(line => line.trim() !== '');
            
            if (lines.length === 0) {
                logsElement.innerHTML = '<div class="log-line log-warning">–õ–æ–≥–∏ –ø—É—Å—Ç—ã</div>';
                return;
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏—é —Å–∫—Ä–æ–ª–ª–∞ –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
            const wasScrolledToBottom = logsElement.scrollHeight - logsElement.scrollTop <= logsElement.clientHeight + 10;
            
            logsElement.innerHTML = lines.map(line => {
                // –î–æ–±–∞–≤–ª—è–µ–º —Ü–≤–µ—Ç–æ–≤—É—é –ø–æ–¥—Å–≤–µ—Ç–∫—É –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π
                let className = 'log-line';
                if (line.includes('[OK]') || line.includes('—É—Å–ø–µ—à–Ω–æ') || line.includes('success')) {
                    className += ' log-success';
                } else if (line.includes('[ERROR]') || line.includes('–æ—à–∏–±–∫–∞') || line.includes('error')) {
                    className += ' log-error';
                } else if (line.includes('[WARN]') || line.includes('warning') || line.includes('WARNING')) {
                    className += ' log-warning';
                } else if (line.includes('[MOVE]') || line.includes('[SWITCH]') || line.includes('[INFO]') || line.includes('Movement')) {
                    className += ' log-info';
                }
                return '<div class="' + className + '">' + escapeHtml(line) + '</div>';
            }).join('');
            
            // –ê–≤—Ç–æ—Å–∫—Ä–æ–ª–ª –≤–Ω–∏–∑ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±—ã–ª –≤–Ω–∏–∑—É
            if (wasScrolledToBottom) {
                setTimeout(() => {
                    logsElement.scrollTop = logsElement.scrollHeight;
                }, 0);
            }
        }
        
        async function updateLogs() {
            try {
                const result = await API.getLogs();
                const logsElement = document.getElementById('logs');
                
                if (!logsElement) return;
                
                if (result.success && result.data) {
                    renderLogs(logsElement, result.data);
                } else {
                    logsElement.innerHTML = '<div class="log-line log-warning">–û–∂–∏–¥–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...</div>';
                }
            } catch (error) {
                console.error('Error fetching logs:', error);
                const logsElement = document.getElementById('logs');
                if (logsElement) {
                    logsElement.innerHTML = '<div class="log-line log-error">–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + escapeHtml(error.message) + '</div>';
                }
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        async function clearLogs() {
            try {
                const result = await API.clearLogs();
                if (result.success) {
                    showMessage('‚úÖ –õ–æ–≥–∏ –æ—á–∏—â–µ–Ω—ã', 'success');
                } else {
                    showMessage('‚ùå –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –ª–æ–≥–æ–≤: ' + result.message, 'error');
                }
                updateLogs();
            } catch (error) {
                console.error('Error clearing logs:', error);
                showMessage('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –ª–æ–≥–æ–≤', 'error');
            }
        }
        
        async function downloadLogs() {
            try {
                showMessage('üíæ –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –ª–æ–≥–æ–≤...', 'info');
                
                // –°–∫–∞—á–∏–≤–∞–µ–º –ª–æ–≥–∏ –∫–∞–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª
                const response = await fetch('/api/logs/download');
                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è: ' + response.status);
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏–º—è —Ñ–∞–π–ª–∞ —Å —Ç–µ–∫—É—â–µ–π –¥–∞—Ç–æ–π/–≤—Ä–µ–º–µ–Ω–µ–º
                const now = new Date();
                const timestamp = now.toISOString().replace(/[:.]/g, '-').slice(0, -5);
                a.download = `logs_${timestamp}.txt`;
                
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                showMessage('‚úÖ –õ–æ–≥–∏ —Å–∫–∞—á–∞–Ω—ã', 'success');
            } catch (error) {
                console.error('Error downloading logs:', error);
                showMessage('‚ùå –û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –ª–æ–≥–æ–≤: ' + error.message, 'error');
            }
        }
        
        // –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ª–æ–≥–æ–≤ –∫–∞–∂–¥—ã–µ 1 —Å–µ–∫—É–Ω–¥—É
        logsInterval = setInterval(updateLogs, 1000);
        
        // –ü–µ—Ä–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–æ–≥–æ–≤ —Å—Ä–∞–∑—É
        updateLogs();
    </script>
</body>

</html>